---
sidebar_position: 30
---

# 計算式

計算式はデータベースの設定の中で動的に値を決定する部分を記述します。

## 計算式が利用できる場所

属性定義やインタフェース定義の以下の場所では、計算式を記述することができます。ここでは、その評価方法を説明します。なお、[システム設定](systemSetting)で「計算式トレースログを有効にする」を有効にすることで、インタフェースの初期化式・自動更新バッチの自動更新・更新伝播の各処理での式評価結果のトレースログを出力できます。

-   [属性定義](propertyDefinition)の列挙値式
-   [属性値導出](propertyDerivation)の計算式と条件式
-   [インタフェース定義](interfaceDefinition)のフィルタ導出式
-   [バリデーション定義](validationDefinition)のチェック式とメッセージ式

## 組み込み関数

計算式は JavaScript の式であり、以下の関数を使用することができます。

|関数名|説明|サーバ|ガジェット|
|---|---|---|-----|
|this\(\)|編集対象となっているオブジェクトを取得する。 本関数の結果オブジェクトが保持する属性の値は、正規化・補正された値が設定される。 また、編集対象オブジェクトに設定されている属性のほか、属性定義で「導出式設定が設定されており、かつ、自オブジェクトの更新伝播の伝播先に指定されている」または 「自オブジェクトの更新伝播の伝播元または依存属性に指定されている」属性についても、式評価結果を参照できる。ただし、インタフェース定義でアクセス対象外に指定されている属性は参照できない。|○|○|
|parent\(\)|編集対象となっているオブジェクトが別のオブジェクトに内包されている場合に、内包している親オブジェクトを取得する|○|○|
|grandparent\(\)|編集対象となっているオブジェクトが別のオブジェクトに 2 段階で内包されている場合に、内包している祖父オブジェクトを取得する|○|○|
|user\(\)|アクセスしているユーザのユーザID を取得する|○|○|
|groups\(\)|アクセスしているユーザのグループの文字列配列 を取得する|○|○|
|roles\(\)|アクセスしているユーザのロールオブジェクト を取得する|○|○|
|getResource\(path1\[, path2\[, path3\]\] \[, filterObj\]\)|引数の文字列を結合し、そこで指定されたリソースを取得する。path2が指定された場合、path1（入力値） と path2（入力値のURLエンコード値）を "/" （path1 の末尾が "/" の場合は"" ）　で連結した文字列のリソースを取得する。 path3 が指定された場合、path1, path2の連結文字列と path3 （入力値のURLエンコード値）を"" で連結した文字列のリソースを取得する。 filterObj に[問い合わせ式](querymongoDB)のオブジェクトを指定することで、フィルタ条件を設定できる。|○|○|
|max\(a,b\)|a と b の大きいほうを返す|○|○|
|rand\(a,b\)|a から b の範囲の整数の乱数を返す|○|○|
|uuid\(\)|UUID を生成する。|○|○|
|find\(array, key, value\)|オブジェクトの配列 array から key の属性が value である最初のオブジェクトを探して返す。array が null の場合は、空のオブジェクトを返す。|○|○|
|generatePwd\(n\)|[システム設定](systemSetting)で設定されたパスワードポリシーに従った n 文字のパスワードを生成する。また、生成したパスワードは見分けのつけにくい文字（「0（ゼロ）」、「1（イチ）」、「I（アイ）」、「O（オー）」、「\|（パイプ）」、「o（オー）」、「l（エル）」）を含まない。|○|○|
|generatePwd\(n, regex\)|generatePwd\(n\)と同様のパスワードポリシーに従い、regexで指定された正規表現を満たすパスワードを生成する。|×|○|
|select\(array, property\)|オブジェクトの配列 array から property のプロパティを取得し、配列として返す。array が null の場合や、array 内の各オブジェクトに property のプロパティが存在しない場合には長さ 0 の配列を返す。|○|○|
|uniq\(array\)|配列 array 内の重複を排除した配列を返す。各要素が同じかどうかの判定には、JavaScript 演算子 === を使用する。つまり、array の各要素がオブジェクトの場合には重複排除されない。また、異なるデータ型の場合（例：整数型の1と文字列型の"1"）も、重複排除されない。array が null の場合や、array の長さが 0 の場合には、長さ 0 の配列を返す。|○|○|
|union\(array1\[, array2, ..., arrayN\]\)|配列 array1 ... arrayN の各要素を含む配列を返す。引数に null が指定された場合、長さ 0 の配列が指定されたものとして処理する。引数で指定された配列すべてに要素が含まれない場合には空の配列を返す。なお、引数に"配列の配列"を指定した場合、ネストした配列は展開されない（例：union\(\[1,2,3\],\[\[1,2,3\], \[4,5,6\]\] =\> \[1,2,3,\[1,2,3\], \[4,5,6\]\]）。ネストした配列を展開する場合は flatten\( array, false\) を使用すること。|○|○|
|flatten\(array, shallow\)|配列 array 内のネストした配列を展開する。shallow が指定された場合、単一階層の展開を行う。（例：flatten\(\[1, \[2\], \[3, \[\[4\]\]\]\]\) =\> \[1, 2, 3, 4\] 、flatten\(\[1, \[2\], \[3, \[\[4\]\]\]\], true\) =\> \[1, 2, 3, \[\[4\]\]\]）|○|○|
|db\(\)|当該のオブジェクトが登録されているデータベースを返す。MetaAndRepository インタフェースへのアクセス時など、データベース名が不明な場合には null を返す。|○|○|
|Date\(\[expr\]\)|Dateオブジェクトを返す。引数が指定された場合、指定された日時のDateオブジェクトを返す。引数には、「1970/1/1 00:00:00からの経過時間（ミリ秒）を表す数値」または「日時を表す文字列」を設定できる。引数が指定されなかった場合、現在日時のDateオブジェクトを返す。日時型プロパティの計算式の結果がDateオブジェクトの場合、"YYYY-mm-ddTHH:MM:ssZ"形式に変換される。日付型プロパティの計算式の結果がDateオブジェクトの場合、ブラウザまたはサーバのタイムゾーン設定の"YYYY-MM-DD"形式に変換される。|○|○|
|getUnusedIpAddr \(fromIp, toIp, usedIps\)|fromIp から toIp の範囲のIPアドレスのうち、usedIps （IPアドレス配列）に含まれないアドレスのもっとも若いものを返す。 範囲内のIPアドレスが全て usedIps に含まれる場合には null を返す。|○|○|
|getUnusedId \(interfaceName, prefix, conflictResolverArray, suffix\)|競合解消文字列配列　conflictResolverArray　に指定された配列から競合解消文字列を１個選び、ID文字列のプレフィックス prefix とサフィックス suffix を前後に結合して候補文字列を生成します。これをキーとして検索インタフェース名 interfaceName で指定されたインタフェースに問い合わせ、競合するオブジェクトが見つからなかった場合は、その候補文字列を返します。競合するオブジェクトが見つかった場合は、次の競合解消文字列を選び、同じ動作を繰り返します。競合解消文字列は配列の先頭から順に試されます。検索インタフェース名で指定されたインタフェースが引数付きインタフェースの場合は、候補文字列は引数として渡され、結果の配列が空の場合に競合がなかったとみなされます。全ての候補文字列で競合するオブジェクトが見つかった場合、エラーを返します。競合解消文字無しの候補値を試行する場合、競合解消文字列配列の先頭に空文字列\(""\)を設定します。 （例：ローマ字名の先頭１文字、"-" 、ローマ字姓、競合解消文字列、"@" 、ドメイン名を結合してメールアドレスを生成する場合　「getUnusedId\("mailList", this\(\).roma\_gn.substr\(0,1\) + "-" + this\(\).roma\_sn, \[""\].concat\(select\(getResource\("/IDManager/conflictResolverStrings"\), "value"\)\),"@" + this\(\).domainName\)」. ここで、mailList は　mail 属性を引数としたインタフェースであり、 conflictResolverStrings は競合解消文字列のテーブルで 、"" を含む配列と concat で結合することにより、最初は競合解消文字列なしの候補で試行することになります。）|○|○|
|getUnusedId \(interfaceName, prefix, randomNumberSpec, suffix\)|競合解消文字列生成ルール　randomNumberSpec　に指定されたルールに従った乱数を生成し、ID文字列のプレフィックス prefix とサフィックス suffix を前後に結合して候補文字列を生成します。 これをキーとして検索インタフェース名 interfaceName で指定されたインタフェースに問い合わせ、競合するオブジェクトが見つからなかった場合は、その候補文字列を返します。競合するオブジェクトが見つかった場合は、次の乱数を1個生成し、同じ動作を繰り返します。 検索インタフェース名で指定されたインタフェースが引数付きインタフェースの場合は、候補文字列は引数として渡され、結果の配列が空の場合に競合がなかったとみなされます。 乱数生成処理を10,000回試行しても条件に適合する値を導出できない場合、エラーとなります。 競合解消文字列生成ルールは JSON オブジェクトで指定します。以下の属性を指定してください。

|属性名|データ型|意味|
|type|文字列|文字列の生成方法を指定します。"random"を指定してください。|
|numberOfDigits|整数|桁数を指定してください。その桁数で表現可能な整数の中から1個ランダムに数値を選び、桁数に満たない場合は0を左に詰めて文字列を生成します。1以上の数値以外が設定された場合、生成時にエラーとなります。|
|excludeSameNumbers|整数|生成した文字列に、同じ数字がここで指定した桁数以上連続した場合はその番号が除外されます（生成をやり直します）。この属性が指定されていない場合、この除外は行われません。1が指定された場合、生成時にエラーとなります。|
|excludeRegexp|文字列|生成した文字列が、ここで指定した正規表現にマッチする乱数は除外されます（生成をやり直します）。この属性が指定されていない場合、この除外は行われません。正規表現がコンパイルできない場合、生成時にエラーとなります。|

 例1

```
getUnusedId("allUserIf", "", {type:"random",numberOfDigits:6, excludeSameNumbers:5, excludeRegexp:"^0"}, Date().getFullYear().toString(10).substr(2,2))
```

例2

```
getUnusedId("allUserIf", "k", {type:"random",numberOfDigits:7, excludeSameNumbers:5}, "")
```

|○|○|
|stringify\(\[expr\]\)|引数のJSON文字列表現を返す。|○|○|
|getAddressList \(fromIp, toIp\)|fromIp から toIp の範囲のIPアドレスの配列を返す。引数がIPv4アドレスとして不正な形式の場合や、オクテット毎の数値比較でfromIpがtoIpよりも大きい場合には、空の配列を返す。|○|○|
|romanize \(kana\)|引数で渡されたカナ文字列をカタカナ補正後、パスポート方式のヘボン式ローマ字に変換して返す。ただし、長音ではない読みの判定はできないため、非長音である可能性のある読みでも長音として変換する。|○|○|
|containsTyoon \(kana\)|引数で渡されたカナ文字列をカタカナ補正後、romanize 関数が長音として変換するつづりで非長音の可能性があるものが含まれている場合は true を返す。|○|○|

サーバの列は、REST API を呼び出した時などに BindBroker によって評価される際の使用可否を表します。ガジェットの列は、編集時に列挙値式、導出式やバリデーションを評価する際の使用可否を表します。

## JavaScript オブジェクトの関数

計算式では、JavaScript オブジェクトの関数を使用することが出来ます。

例

```
this().hello_world ? this().hello_world.substring(6) : null
```

結果 （計算式を jsfunc\_example 属性に指定）

```
{
  "hello_world": "Hello World!",
  "jsfunc_example": "World!"
}
```

IDM の属性のデータ型と、JavaScript のオブジェクト型の対応は以下のとおりです。

|IDM 属性データ型|JavaScript のオブジェクトの型|
|----------|--------------------|
|文字列|String|
|ブール|Boolean|
|整数|Number|
|浮動小数点数|Number|
|日時|Date|
|日付|Date|
|IPアドレス|String|
|オブジェクト|Object|
|（配列）|Array|

注意事項を以下に示します。

-   サーバ側では ECMAScript5 相当の関数を使用できる。ガジェット側で使用できる関数はブラウザ実装に依存する。
-   Array.prototype.shift のように、使用した関数が、呼び出し元のオブジェクトを更新する場合がある点に注意する。

## 計算式トレースログの閲覧方法

[システム設定](systemSetting)で「計算式トレースログを有効にする」を有効にすることで、インタフェースの初期化式・自動更新バッチの自動更新・更新伝播の各処理での式評価結果のトレースログを出力できます。 計算式トレースログの閲覧方法については未執筆です。


